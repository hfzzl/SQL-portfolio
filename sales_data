-- Query 1: Analyze total orders, revenue, and profit by country
SELECT 
    country,
    COUNT(*) AS total_orders, -- Total number of orders in each country
    ROUND(SUM(revenue), 2) AS total_revenue, -- Total revenue generated by each country
    ROUND((SUM(revenue) - SUM(cost)), 2) AS total_profit -- Total profit calculated as revenue minus cost
FROM sales_data
GROUP BY country; -- Group data by country to aggregate results
ORDER BY total_profit DESC

-- Germany has the highest profit and France is the lowest profit.

-- Query 2: Analyze customer demographics and spending patterns
SELECT 
    country,
    customer_gender,
    ROUND(AVG(customer_age)) AS average_age, -- Average age of customers by gender and country
    ROUND(AVG(revenue), 2) AS average_amount_spent -- Average amount spent per customer
FROM sales_data
GROUP BY country, customer_gender -- Group data by country and gender for detailed analysis
ORDER BY average_amount_spent DESC; -- Sort by average spending to identify high-value segments

-- Customer with highest average amount spent are both male and female customers from Germany with average age of 35 followed by male customers from France with average age of 35/
-- Least average amount spent can be seen from customers from united states.

-- Query 3: Calculate sales distribution across product categories
SELECT
    product_category,
    COUNT(*) AS total_sold, -- Total number of products sold in each category
    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER (), 2) AS percentage_sold -- Percentage of total sales contributed by each category
FROM sales_data
GROUP BY product_category; -- Group by product category to calculate metrics

-- 65% of sold product is accessories followed by bikes (20%) and clothing (15%).

-- Query 4: Rank customer segments based on total spending
WITH CustomerSpending AS ( 
    SELECT
        customer_gender,
        customer_age,
        COUNT(*) AS total_customer, -- Total number of customers in each segment
        SUM(revenue) AS total_spent -- Total revenue generated by each customer segment
    FROM sales_data
    GROUP BY customer_gender, customer_age
)
SELECT
    RANK() OVER (ORDER BY total_spent DESC) AS rank, -- Rank customer segments by total spending
    customer_gender,
    customer_age,
    total_customer,
    total_spent
FROM CustomerSpending
LIMIT 10; -- Show top 10 customer segments

-- Younger males (28-31) are the most lucrative customer segment, while females in their late 20s and early 30s also represent significant revenue potential.

-- Query 5: Analyze monthly revenue growth over time
WITH MonthlyRevenue AS (
    SELECT
        year,
        month,
        date,
        SUM(revenue) AS total_revenue -- Total revenue for each month
    FROM sales_data
    GROUP BY year, month
    ORDER BY date
),
RevenueWithLag AS (
    SELECT
        year,
        month,
        total_revenue,
        LAG(total_revenue) OVER (ORDER BY date) AS previous_month_revenue -- Revenue from the previous month
    FROM MonthlyRevenue
)
SELECT
    year,
    month,
    total_revenue,
    previous_month_revenue,
    CASE 
        WHEN previous_month_revenue IS NULL THEN NULL
        ELSE (total_revenue - previous_month_revenue) * 100.0 / previous_month_revenue -- Growth rate formula
    END AS growth_rate
FROM RevenueWithLag;

-- Revenue steadily increased in 2015, with a sharp rise in July (133.6%) and a big drop in July 2016 (-79%).

-- Query 6: Identify the top 10 sub-categories by revenue contribution
WITH SubCategoryRevenue AS (
    SELECT
        sub_category,
        SUM(revenue) AS total_revenue -- Total revenue for each sub-category
    FROM sales_data
    GROUP BY sub_category
),
TopSubCategories AS (
    SELECT
        sub_category,
        total_revenue,
        RANK() OVER (ORDER BY total_revenue DESC) AS rank -- Rank sub-categories by revenue
    FROM SubCategoryRevenue
)
SELECT
    sub_category,
    total_revenue,
    ROUND(total_revenue * 100.0 / (SELECT SUM(total_revenue) FROM SubCategoryRevenue), 2) AS percentage_contribution -- Percentage of total revenue
FROM TopSubCategories
WHERE rank <= 10 -- Filter top 10 sub-categories
ORDER BY total_revenue DESC;

-- Mountain Bikes (23.17%) and Road Bikes (17.55%) drive most sales, showing that bikes and their accessories are key revenue sources.

-- Query 7: Find the best-selling product category in each country
WITH RankedCategories AS (
    SELECT
        country,
        product_category,
        COUNT(*) AS total_sales, -- Total sales for each category in a country
        RANK() OVER (PARTITION BY country ORDER BY COUNT(*) DESC) AS rank_within_country -- Rank categories by sales within each country
    FROM sales_data
    GROUP BY country, product_category
)
SELECT
    country,
    product_category,
    total_sales,
    rank_within_country
FROM RankedCategories
WHERE rank_within_country = 1 -- Filter top-ranked category for each country
ORDER BY country;

-- Accessories are the top-selling category across all countries, with the U.S. leading in sales, reflecting high global demand.

-- Query 8: Analyze monthly performance of each product category
SELECT
    year,
    month,
    product_category,
    SUM(quantity) AS total_quantity, -- Total quantity sold
    ROUND(SUM(revenue), 2) AS total_revenue, -- Total revenue generated
    ROUND((SUM(revenue) - SUM(cost)), 2) AS total_profit_or_loss -- Profit or loss for the category
FROM sales_data
GROUP BY year, month, product_category -- Group data by year, month, and product category
ORDER BY date ASC; -- Sort by date for chronological analysis

-- Sales peak in December, particularly for Bikes, Accessories, and Clothing, making the holiday season crucial for revenue.
